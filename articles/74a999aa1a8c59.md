---
title: "Next.jsã®Middlewareã§Amplify Auth(Cognito)ã®èªè¨¼çŠ¶æ…‹ã«ã‚ˆã£ã¦ãƒ­ã‚°ã‚¤ãƒ³å‰å¾Œã®ç”»é¢ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹"
emoji: "ğŸ˜"
type: "tech"
topics:
  - "amplify"
  - "nextjs"
  - "cognito"
  - "aws"
published: true
published_at: "2022-12-02 20:02"
---

:::message
ã“ã®è¨˜äº‹ã¯ [AWS Amplify ã¨ AWSÃ— ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ Advent Calendar 2022](https://qiita.com/advent-calendar/2022/amplify) ï¼’æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

ã“ã‚“ã«ã¡ã‚ã€‚ [ZUMA](https://twitter.com/zuma_lab) ã§ã™ã€‚

èªè¨¼ãŒå¿…é ˆã® MPA ã® WEB ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹éš›ã«ä»¥ä¸‹ã® URL ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¦ä»¶ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚

- ãƒ«ãƒ¼ãƒˆ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸå ´åˆã€èªè¨¼å‰ã§ã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã€èªè¨¼å¾Œã§ã‚ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
- èªè¨¼å‰ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã® URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸå ´åˆã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
- èªè¨¼å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã® URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸå ´åˆã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
- åˆ©ç”¨è¦ç´„ã‚„ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ç”»é¢ã¯èªè¨¼çŠ¶æ…‹ã«é–¢ä¿‚ç„¡ãè¡¨ç¤ºã™ã‚‹

è¦ä»¶ã‚’å®Ÿç¾ã•ã›ã‚‹ç‚ºã«ã¾ãšä»¥ä¸‹å‡¦ç†ã‚’æ€ã„ã¤ãã¾ã—ãŸã€‚

- å„ç”»é¢ã§èªè¨¼çŠ¶æ…‹ã‚’è¦‹ã¦ä»–ç”»é¢ã«ãƒªãƒ€ãƒ¬ã‚¯ãƒˆã™ã‚‹
- ç”»é¢å…±é€šã§å‘¼ã°ã‚Œã‚‹ç®‡æ‰€(Next.js ã ã¨\_app.tsx ãªã©)ã§èªè¨¼çŠ¶æ…‹ã¨ URI ã‚’è¦‹ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

ã—ã‹ã—ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã®ãƒ­ã‚¸ãƒƒã‚¯ã«é–¢ä¿‚ç„¡ã„èªè¨¼ã®é–¢å¿ƒäº‹ã¯å¤–éƒ¨ã«ã¾ã¨ã‚ã¦å®Ÿè£…ã—ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚

ãã“ã§ Next.js ã«ã¯ Middleware ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Œäº†ã™ã‚‹å‰ã«ã‚¨ãƒƒã‚¸ç’°å¢ƒã§å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚

https://nextjs.org/docs/advanced-features/middleware

Next.js ã® v12.2 ã‹ã‚‰ Middleware ãŒ stable ã«ãªã£ã¦ã„ã‚‹ã®ã§ Middleware ã§èªè¨¼çŠ¶æ…‹ã‚’åˆ¤å®šã—ã¦ URL ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

èªè¨¼ã«ã¯ AWS Amplify ã® Amplify Auth ã‚«ãƒ†ã‚´ãƒª(Cognito)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã¡ãªã¿ã«ç­†è€…ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºæ­´ãŒæµ…ã„ã®ã§ã€é–“é•ãˆã¦ã„ã‚‹ç®‡æ‰€ã‚ã‚Œã°ã¶ã‚“ã¶ã‚“ãƒã‚µã‚«ãƒªãŠé¡˜ã„ã—ã¾ã™ã€‚

# å®Ÿè¡Œç’°å¢ƒ

- Node
  - 16.13.0
- npm
  - 8.1.0
- Next.js
  - 13.0.5
- Amplify CLI
  - 10.5.1

# Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```
npx create-next-app@latest --ts --use-npm nextjs-cognito-middleware-sample
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ç§»å‹•ã—ã¾ã™ã€‚

```
cd nextjs-cognito-middleware-sample
```

# Middleware ã®åˆ¶ç´„

Middleware ã¯ Web æ¨™æº–ã® API ã‚’ä½¿ã£ãŸã‚¨ãƒƒã‚¸ç’°å¢ƒã§å‹•ãã®ã§åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚

https://nextjs.org/docs/api-reference/edge-runtime#unsupported-apis

ä¾‹ãˆã° Middleware ã§ Web æ¨™æº–ã® API ä»¥å¤–ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä¾å­˜ã™ã‚‹ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```
error - (middleware)/node_modules/@aws-amplify/core/lib-esm/Util/Reachability.js (11:0) @ <unknown>
error - window is not defined
null
```

æœ€åˆä½•æ•… Middleware ä¸Šã§ã»ã¨ã‚“ã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå‹•ã‹ãªã„ã‚“ã ã¨ãƒãƒã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã€‚

aws-amplify ã‚„ aws-jwt-verify ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚Œã°ç°¡å˜ã« Cognito ã®èªè¨¼çŠ¶æ…‹ã‚’åˆ¤åˆ¥å‡ºæ¥ã¾ã™ã€‚

ã§ã™ãŒ Middleware ã§ã¯ä½¿ãˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒé™ã‚‰ã‚Œã‚‹ã®ã§ã€èªè¨¼çŠ¶æ…‹ã®åˆ¤å®šå‡¦ç†ã®å¤§éƒ¨åˆ†ã‚’é ‘å¼µã£ã¦è‡ªå‰ã§æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

è‰²ã€…èª¿ã¹ã¦ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒèªè¨¼éƒ¨åˆ†ã®åˆ¤å®šã«ä½¿ãˆãã†ã ã£ãŸã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
npm i jose
```

# Middleware ã®å‡¦ç†ã®æµã‚Œ

Middlerare ã®å‡¦ç†ã®æµã‚Œã¯å¤§ããä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. Cookie ã‹ã‚‰ Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³(idToken/accessToken/refreshToken)ã‚’å–å¾—
2. Cookie ã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡ã‘ã‚Œã°æœªèªè¨¼çŠ¶æ…‹
3. Cookie ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—å‡ºæ¥ã‚Œã° idToken ã‚’ JWT æ¤œè¨¼
4. JWT æ¤œè¨¼çµæœã‚¨ãƒ©ãƒ¼ã ã£ãŸå ´åˆæœªèªè¨¼çŠ¶æ…‹
5. JWT æ¤œè¨¼ã‚’é€šéã™ã‚Œã°èªè¨¼æ¸ˆ
6. idToken ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹å ´åˆ refreshToken ã§ idToken/acccessToken ã‚’å†ä½œæˆ
7. å†ä½œæˆã—ãŸ idToken/accessToken ã‚’ Cookie ã«ã‚»ãƒƒãƒˆ

## Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã¯

ä»Šå› Middleware ã§ã¯ Cookie ã«ä¿å­˜ã•ã‚ŒãŸ Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦èªè¨¼çŠ¶æ…‹ã‚’åˆ¤åˆ¥ã—ã¾ã™ã€‚

Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯ä»¥ä¸‹ã® 3 ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚

|              | ç”¨é€”                                             | æœ‰åŠ¹æœŸé™(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) |
| ------------ | ------------------------------------------------ | -------------------- |
| idToken      | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹èªè¨¼ã¾ãŸã¯èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å‚ç…§ | 1 æ™‚é–“               |
| accessToken  | ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã®è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤                   | 1 æ™‚é–“               |
| refreshToken | æ–°ã—ã„ idToken ãŠã‚ˆã³ accessToken ã®å–å¾—         | 30 æ—¥                |

ä»Šå›èªè¨¼åˆ¤å®šã«ã¯ idToken ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

idToken ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹å ´åˆã¯ refreshToken ã‚’ä½¿ç”¨ã—ã¦ idToken/acccessToken ã‚’å†ä½œæˆã—ã¦ Cookie ã«è©°ã‚ç›´ã—ã¾ã™ã€‚

accessToken ã¯ä»Šå›ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ãŒã€ç­†è€…ã®å ´åˆ accessToken ã¯è‡ªå‰ã® API ã‚µãƒ¼ãƒã®èªè¨¼ã§åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

API ã‚µãƒ¼ãƒã¸ã® request header ã« `Authorization: Bearer ${accessToken}` ã‚’ä»˜ã‘ã¦ API ã‚µãƒ¼ãƒã®èªè¨¼å‡¦ç†ã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã§ã™ã®ã§ refreshToken ã§ idToken ã‚’å†ä½œæˆã™ã‚‹å ´åˆã¯å¿…ãš accessToken ã‚‚å†ä½œæˆã—ã¦ Cookie ã«ã¯å¸¸ã«æœ€æ–°ã® idToken/accessToken ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

# Amplify ã‚’è¨­å®šã™ã‚‹

## Amplify ã®åˆæœŸåŒ–

å‰æã¨ã—ã¦ Amplify CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã€ `amplify configure` ã§ Amplify ã§ä½¿ç”¨ã™ã‚‹ AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½œæˆæ¸ˆã¿ã¨ã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Amplify ã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™ã€‚

```
amplify init
```

è¨­å•ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€šã‚Šå›ç­”ã—ã¦ã„ãã¾ã™ã€‚

```
Note: It is recommended to run this command from the root of your app directory
? Enter a name for the project nextjscognitomiddlew
The following configuration will be applied:

Project information
| Name: nextjscognitomiddlew
| Environment: dev
| Default editor: Visual Studio Code
| App type: javascript
| Javascript framework: react
| Source Directory Path: src
| Distribution Directory Path: build
| Build Command: npm run-script build
| Start Command: npm run-script start

? Initialize the project with the above configuration? Yes
Using default provider  awscloudformation
? Select the authentication method you want to use: AWS profile

For more information on AWS Profiles, see:
https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html

? Please choose the profile you want to use [è‡ªèº«ã®ç’°å¢ƒã®profileã‚’é¸æŠ]
Adding backend environment dev to AWS Amplify app: dmgki8ps6fwkm

Deployment completed.
Deployed root stack nextjscognitomiddlew [ ======================================== ] 4/4
	amplify-nextjscognitomiddlew-â€¦ AWS::CloudFormation::Stack     CREATE_COMPLETE                Thu Dec 01 2022 16:38:31â€¦
	DeploymentBucket               AWS::S3::Bucket                CREATE_COMPLETE                Thu Dec 01 2022 16:38:11â€¦
	UnauthRole                     AWS::IAM::Role                 CREATE_COMPLETE                Thu Dec 01 2022 16:38:28â€¦
	AuthRole                       AWS::IAM::Role                 CREATE_COMPLETE                Thu Dec 01 2022 16:38:29â€¦

âœ” Help improve Amplify CLI by sharing non sensitive configurations on failures (y/N) Â· no
Deployment bucket fetched.
âœ” Initialized provider successfully.
âœ… Initialized your environment successfully.
```

## Amplify Auth ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã™ã‚‹

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Amplify Auth ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
amplify add auth
```

ä»Šå› Next.js ã® Middleware æ¤œè¨¼ã®ç‚ºã€Cognito ã®è¨­å®šã¯æœ€ä½é™ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã®èªè¨¼ã¨ã—ã¾ã™ã€‚

```
Using service: Cognito, provided by: awscloudformation

 The current configured provider is Amazon Cognito.

 Do you want to use the default authentication and security configuration?
â¯ Default configuration
  Default configuration with Social Provider (Federation)
  Manual configuration
  I want to learn more.
 How do you want users to be able to sign in?
  Username
â¯ Email
  Phone Number
  Email or Phone Number
  I want to learn more.
 Do you want to configure advanced settings? (Use arrow keys)
â¯ No, I am done.
  Yes, I want to make some additional changes.
âœ… Successfully added auth resource nextjscognitomiddlewe0c8d7ed locally

âœ… Some next steps:
"amplify push" will build all your local backend resources and provision it in the cloud
"amplify publish" will build all your local backend and frontend resources (if you have hosting category added) and provision it in the cloud
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ãŸ Amplify Auth ã‚«ãƒ†ã‚´ãƒªã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚

```
amplify push -y
```

# ç”»é¢ã®å®Ÿè£…ã‚’ã™ã‚‹

## å…±é€šå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹

ã¾ãšã¯ `pages/_app.tsx` ã«å…¨ç”»é¢ã®å…±é€šå‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
npm i @aws-amplify/ui-react aws-amplify
```

`Authenticator.Provider` ã§ Component ã‚’ãƒ©ãƒƒãƒ—ã—ã¦å…¨ç”»é¢ã§ `useAuthenticator` hook ã‚’åˆ©ç”¨å¯èƒ½ã«ã—ã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/pages/_app.tsx

ãƒã‚¤ãƒ³ãƒˆã¯ `Amplify.configure` ã§ `ssr: true` ã¨è¨­å®šã™ã‚‹ã“ã¨ã§ã™ã€‚

Cognito ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã® Local Storage ã«ä¿å­˜ã—ã¾ã™(è¨­å®šã§ Session storage ã«ä¿å­˜ã‚‚å¯èƒ½)ã€‚

ssr ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Cookie ã«ä¿å­˜ã—ã¾ã™ã€‚

èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Cookie ã«ä¿å­˜ã™ã‚‹äº‹ã«ã‚ˆã‚Šã€Middleware ã‹ã‚‰ Cookie ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦èªè¨¼çŠ¶æ…‹ã®åˆ¤å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

:::message alert
Cookie ã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹äº‹ã«ã‚ˆã‚Š XSS ã‚„ CSRF ã®ã‚»ã‚­ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã—ã¾ã™ã€‚
Local Storage/Session storage ã«èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦ã„ã‚‹å ´åˆã‚‚ãã†ã§ã™ãŒã€æœ¬ç•ªé‹ç”¨ã§ã¯ãã‚Œãã‚Œã‚»ã‚­ãƒªãƒ†ã‚£å¯¾ç­–ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
:::

## ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’å®Ÿè£…ã™ã‚‹

å®Ÿè£…ã¯å…¬å¼ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ã„ã¾ã™ã€‚

https://ui.docs.amplify.aws/react/connected-components/authenticator

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/pages/signin.tsx

`http://localhost:3000/signin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/824b30605490-20221202.png)

Sign Up ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå¾Œã€Cognito ä¸Šã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/654b14e1a6e7-20221202.png)

## ãã®ä»–ã®ç”»é¢ã‚’å®Ÿè£…ã™ã‚‹

èªè¨¼æ¸ˆã¿ã®çŠ¶æ…‹ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã§ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/pages/dashboard.tsx

èªè¨¼çŠ¶æ…‹ã«é–¢ä¿‚ç„¡ãã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã‚‹åˆ©ç”¨è¦ç´„ç”»é¢ã§ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/pages/terms.tsx

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹

Middleware ä¸Šã§ã¯ç’°å¢ƒå¤‰æ•°ãŒä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

https://nextjs.org/docs/api-reference/edge-runtime#environment-variables

`ï½“ï½’ï½ƒ/aws-exports.js` ã®å€¤ã‚’åˆ©ç”¨å‡ºæ¥ã‚Œã°è‰¯ã„ã®ã§ã™ãŒã€Middleware ã®ã‚¨ãƒƒã‚¸ç’°å¢ƒã‹ã‚‰ã¯ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ãªã„ã®ã§åˆ¥é€”ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

COGNITO_URL ä»¥å¤–ã¯ `src/aws-exports.js` ã«ã‚ã‚‹å€¤ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```:.env.development.local
REGION="ap-northeast-1"
COGNITO_USER_POOLS_ID="ap-northeast-1_XXXXXXXX"
COGNITO_USER_POOLS_WEB_CLIENT_ID="1rjnt22ltlaXXXXXXXXXXXXX"
COGNITO_URL="https://XXXXXXXXXX.auth.ap-northeast-1.amazoncognito.com"
```

:::message alert
Amplify ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€ `AWS` ãŒäºˆç´„èªã«ãªã£ã¦ã„ã‚‹ã®ã§ç’°å¢ƒå¤‰æ•°ã«ã¯ `AWS_XXXXX` ç­‰ã® prefix ã¯ä»˜ã‘ã‚‹äº‹ãŒã§ãã¾ã›ã‚“ã€‚
https://docs.aws.amazon.com/amplify/latest/userguide/environment-variables.html
:::

COGNITO_URL ã¯ Cognito ã® Console ã§ Cognito ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½œæˆã—ã¦å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚

è©²å½“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã® `ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ±åˆ` ã‚¿ãƒ–ã‚’é–‹ãã¾ã™ã€‚

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ `Cognitoãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä½œæˆ` ã‚’é–‹ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/943ae5e27c7c-20221202.png)

Cognito ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å…¥åŠ›ã—ã¦ `Cognitoãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä½œæˆ` ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/47da1022a51e-20221202.png)

# Middleware ã‚’å®Ÿè£…ã™ã‚‹

ä»¥ä¸‹ãŒ Middleware ã®å®Ÿè£…ã¨ãªã‚Šã¾ã™ã€‚

Middleware ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `middleware.ts` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã ã‘ã§ Vercel ç­‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã‚¨ãƒƒã‚¸ç’°å¢ƒã§å‹•ä½œã—ã¾ã™ã€‚ã“ã‚Œã«ã¯æ„Ÿå‹•ã—ã¾ã—ãŸã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/middleware.ts

## Middleware ã‚’é€šã•ãªã„ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹

ãƒã‚¤ãƒ³ãƒˆã¯ã¾ãšã€ä»¥ä¸‹ Middleware ã® config è¨­å®šã§ Middleware ã‚’é€šã•ãªã„ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

```ts:middleware.ts
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - favicon.ico (favicon file)
     * - .svg (SVG file)
     * - excluded paths (e.g. static screen path)
     */
    "/((?!api|_next/static|favicon.ico|.*\\.svg|terms).*)",
  ],
};
```

ä¸Šè¨˜ã®å ´åˆã€ä¸»ã«é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ä»¥ä¸‹ã® URL ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¦ä»¶ã‚’æº€ãŸã™ç‚ºã€é™çš„ç”»é¢ã§ã‚ã‚‹åˆ©ç”¨è¦ç´„ç”»é¢ `terms` ã®ãƒ‘ã‚¹ã‚’é™¤å¤–ã—ã¦ã„ã¾ã™ã€‚

- åˆ©ç”¨è¦ç´„ã‚„ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ç”»é¢ã¯èªè¨¼çŠ¶æ…‹ã«é–¢ä¿‚ç„¡ãè¡¨ç¤ºã™ã‚‹

## ãƒ«ãƒ¼ãƒˆ URL ã‚¢ã‚¯ã‚»ã‚¹ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

Middleware ã®å…ˆé ­ã§ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ç‚ºã«ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¾ã™

- ãƒ«ãƒ¼ãƒˆ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸå ´åˆã€èªè¨¼å‰ã§ã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã€èªè¨¼å¾Œã§ã‚ã‚Œã°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

```ts:middleware.ts
  const url: NextURL = request.nextUrl.clone();

  const signin = `${url.origin}/signin`;
  const dashboard = `${url.origin}/dashboard`;

  if (url.pathname === "/") {
    return NextResponse.redirect(dashboard);
  }
```

æœªèªè¨¼çŠ¶æ…‹ã®å ´åˆä»¥ä¸‹ã®æµã‚Œã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚

- ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- Middleware ã§æœªèªè¨¼ã§ã‚ã‚‹ã“ã¨ã‚’åˆ¤å®š
- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

## Cookie ã‹ã‚‰ Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹

ä»¥ä¸‹ãŒ Cookie ã‹ã‚‰ Cognito ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/get-cookie-by-cognito-token-type.ts

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/get-cognito-token-from-cookie.ts

Cookie ã«ã¯èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã§æ­£è¦è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ idToken/accessToken/refreshToken ã‚’ãã‚Œãã‚Œå–å¾—ã—ã¾ã™ã€‚

```
CognitoIdentityServiceProvider.{COGNITO_USER_POOLS_WEB_CLIENT_ID}.XXXX-XXXX-XXXX-XXXX-XXXXXXXXX.idToken
```

## æœªèªè¨¼çŠ¶æ…‹ã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ç‚ºã«æœªèªè¨¼çŠ¶æ…‹ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- èªè¨¼å‰ã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã® URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸå ´åˆã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

ã¾ãšã€ `unauthenticatedPaths` ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãªã©èªè¨¼å‰ç”»é¢ã®ãƒ‘ã‚¹ã‚’é…åˆ—ã§è¨˜è¿°ã—ã¾ã™ã€‚(ã“ã¡ã‚‰ã¯å¾Œã»ã©ä½¿ç”¨ã—ã¾ã™)

`authenticatedPaths` ã«ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ãªã©èªè¨¼å¿…é ˆç”»é¢ã®ãƒ‘ã‚¹ã‚’é…åˆ—ã§è¨˜è¿°ã—ã¾ã™ã€‚

ä»¥ä¸‹å®Ÿè£…ã¯ Cookie ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ããªã„çŠ¶æ…‹ã‚’æœªèªè¨¼çŠ¶æ…‹ã¨ã—ã¦ã„ã¾ã™ã€‚

æœªèªè¨¼çŠ¶æ…‹ã‹ã¤ã€èªè¨¼å¿…é ˆç”»é¢ã®ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ(`authenticatedPaths` ã®ãƒ‘ã‚¹ã ã£ãŸå ´åˆ) ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¦è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚

```ts:middleware.ts
const unauthenticatedPaths: string[] = ["/signin"];
const authenticatedPaths: string[] = ["/dashboard"];

export async function middleware(request: NextRequest): Promise<NextResponse> {
  const url: NextURL = request.nextUrl.clone();

  const signin = `${url.origin}/signin`;
  const dashboard = `${url.origin}/dashboard`;

  const cognitoToken: CognitoToken | null = getCognitoTokenFromCookie(request);
  if (!cognitoToken) {
    if (authenticatedPaths.includes(url.pathname)) {
      return NextResponse.redirect(signin);
    }

    return NextResponse.next();
  }
```

## idToken ã‚’ JWT æ¤œè¨¼ã—ã¦èªè¨¼çŠ¶æ…‹ã‚’åˆ¤å®šã™ã‚‹

æ¬¡ã« Cookie ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ããŸå ´åˆã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³(ä»Šå›ã¯ idToken)ã®ä»¥ä¸‹ JWT æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

1. JWT å½¢å¼åˆ¤å®š
2. JWT ç½²åæ¤œè¨¼
3. æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
4. JWT ã‚¯ãƒ¬ãƒ¼ãƒ æ¤œè¨¼

è©³ã—ãã¯ä»¥ä¸‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ãã ã•ã„ã€‚

https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html

ä»¥ä¸‹ãŒ JWT æ¤œè¨¼ã®å®Ÿè£…ã¨ãªã‚Šã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/verify-cognito-token.ts

ä»Šå›ã¯ `jose` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ JWT æ¤œè¨¼ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

## èªè¨¼çŠ¶æ…‹ã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ç‚ºã«èªè¨¼çŠ¶æ…‹ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

- èªè¨¼å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã® URL ã‚’ç›´æ¥å©ã‹ã‚ŒãŸå ´åˆã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹

idToken ãŒ JWT æ¤œè¨¼çµæœã€èªè¨¼çŠ¶æ…‹ã¨åˆ¤å®šã€ã‹ã¤èªè¨¼å‰ç”»é¢ã®ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ(`unauthenticatedPaths` ã®ãƒ‘ã‚¹ã ã£ãŸå ´åˆ) ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã¦è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚

```ts:middleware.ts
  try {
    await verifyCognitoToken(cognitoToken.idToken);

    if (unauthenticatedPaths.includes(url.pathname)) {
      return NextResponse.redirect(dashboard);
    }

    return NextResponse.next();
  } catch (error) {
```

## èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹æœŸé™åˆ‡ã‚Œã®å ´åˆ refreshToken ã§èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ä½œæˆã™ã‚‹

JWT æ¤œè¨¼çµæœã€idToken ã®æœ‰åŠ¹æœŸé™(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1 æ™‚é–“)ãŒåˆ‡ã‚Œã¦ã„ãŸå ´åˆã€refreshToken ã‚’ä½¿ç”¨ã—ã¦ idToken/accessToken ã‚’å†ä½œæˆã—ã¾ã™ã€‚

ã“ã“ã§ç’°å¢ƒå¤‰æ•° COGNITO_URL ã§è¨­å®šã—ãŸ Cognito ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ Cognito ã® url ã« POST ã§ refreshToken ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§å†ä½œæˆã•ã‚ŒãŸ idToken/accessToken ã‚»ãƒƒãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

`https://XXXXXXXXXX.auth.ap-northeast-1.amazoncognito.com/oauth2/token`

ä»¥ä¸‹ãŒå®Ÿè£…ã«ãªã‚Šã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/refresh-cognito-token.ts

æ¬¡ã«å†ä½œæˆã—ãŸèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ Cookie ã«è©°ã‚ç›´ã—ã¾ã™ã€‚

ä¸€åº¦ç¾åœ¨ Cookie ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã€ãã®æƒ…å ±ã‚’å…ƒã«æ–°ã—ã„èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/set-cognito-token-into-cookie.ts

ã“ã¡ã‚‰ãŒä¸Šè¨˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‘¼ã³å‡ºã—å…ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

https://github.com/kazuma-fujita/nextjs-cognito-middleware-sample/blob/main/src/auth/services/refresh-cognito-token-then-set-cookie.ts

ãã—ã¦ Middleware ã‹ã‚‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®å†ä½œæˆã€Cookie ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚

```ts:middleware.ts
    try {
      let response: NextResponse = NextResponse.next();

      response = await refreshCognitoTokenThenSetCookie(
        cognitoToken.refreshToken,
        request,
        response
      );

      return response;
    } catch (error) {
      console.error("failed to the refresh token", error);
    }
```

# å‹•ä½œç¢ºèª

`http://localhost:3000/signin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ AmplifyUI ã® Authenticator ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ ID/PASS ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/713f1038e7c5-20221207.png)

Cognito ã«èªè¨¼æ¸ˆã¿ã®çŠ¶æ…‹ã§å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

Middleware ã§ Cognito ã®èªè¨¼çŠ¶æ…‹ã®åˆ¤å®šçµæœã€èªè¨¼æ¸ˆã¿ãªã®ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/9bdf45cf3367-20221207.png)

é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’é–‹ãã¨ `/signin` ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ 307 ã§ `/dashboard` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/580c3ff01ce6-20221207.png)

æ¬¡ã« Sign Out ã‚’ã—ã¦æœªèªè¨¼çŠ¶æ…‹ã§ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢(`http://localhost:3000/dashboard`) ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œ `/dashboard` ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ 307 ã§ `/signin` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ff63ce2fe827-20221207.png)

ã¾ãŸã€ä»Šå›å®Ÿè£…ã—ãŸèªè¨¼ Middleware ã¯ãƒ«ãƒ¼ãƒˆ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€Middleware ã§èªè¨¼çŠ¶æ…‹ã‚’åˆ¤å®šã—ã¦æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã€èªè¨¼æ¸ˆã¿ãªã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã™ã€‚

Next.js ã® Middleware ã¯ URI ã®ãƒ‘ã‚¹ã‚’æ­£è¦è¡¨ç¾ã§åˆ¤å®šã—ã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã¯ Middleware ã‚’ãƒ‘ã‚¹ã™ã‚‹äº‹ã‚‚å‡ºæ¥ã¾ã™ã€‚

ä»Šå› Middleware ã® config è¨­å®šã§ URI ã‚’åˆ¤å®šã—ã¦åˆ©ç”¨è¦ç´„ãªã©é™çš„ç”»é¢ã¯ Middleware ã‚’é€šã•ãšã€èªè¨¼åˆ¤å®šã«é–¢ä¿‚ç„¡ãè¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ä»¥ä¸Š Next.js ã® Middleware ã§ Amplify Auth(Cognito)ã®èªè¨¼çŠ¶æ…‹ã§ãƒ­ã‚°ã‚¤ãƒ³å‰å¾Œã®ç”»é¢ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹æ–¹æ³•ã§ã—ãŸã€‚

ç­†è€…ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºæ­´ãŒæµ…ã„ç‚ºã€è‡ªå‰ã§èªè¨¼å‘¨ã‚Šã®å®Ÿè£…ã™ã‚‹ã®ãŒçµæ§‹å¤§å¤‰ã§ã—ãŸã€‚

ã‚‚ã£ã¨æ¥½ãªæ–¹æ³•ãŒã‚ã‚Œã°æ˜¯éã‚³ãƒ¡ãƒ³ãƒˆå®œã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚

æ¬¡å›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè£…ã—ãŸèªè¨¼ Middleware ã‚’ Amplify Hosting ã§å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

https://zenn.dev/zuma_lab/articles/next-js-middleware-deploy-to-amplify

## å‚è€ƒã‚µã‚¤ãƒˆ

https://dev.classmethod.jp/articles/study-tokens-of-cognito-user-pools/
